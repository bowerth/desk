###############################
## ICIO
###############################

## setwd('C:\\Users\\werth_b\\LocalData\\Dropbox\\GitHub\\desk\\inst\\industry')

## input <- list(nav_radiant = "Icio",
##               datasets = "STANNAi4")

## menu_name = "Icio"                      # menu_name
## fun_name = "Icio"                       # fun_name
## rfun_label = ".icio"                    # rfun_label
## fun_label = "icio"                      # fun_label


## ## output elements
## output$uiRnd_var # dynamic UI element
## output$uiRnd_block # dynamic UI element
## output$ui_random # UI: inputs
## output$random # UI: statTabPanel
## .random # reactive
## random # function
## summary_random # output for summary tab
## plots_random # output for plots tab

ui.ind <- list(
    "C01T99 TOT" = 38,
    "C15T37 MANUF" = 39,
    "C30T33 ICT" = 41,
    "C50T99 SERV" = 42,
    "C50T74 MKSERV" = 43,
    "C10T74 NAGMK" = 44,
    "......" = 100,
    "C01T05 AGR" = 1,
    "C10T14 MIN" = 2,
    "C15T16 FOD" = 3,
    "C17T19 TEX" = 4,
    "C20 WOD" = 5,
    "C21T22 PAP" = 6,
    "C23 PET" = 7,
    "C24 CHM" = 8,
    "C25 RBP" = 9,
    "C26 NMM" = 10,
    "C27 MET" = 11,
    "C28 FBM" = 12,
    "C29 MEQ" = 13,
    "C30 ITQ" = 14,
    "C31 ELQ" = 15,
    "C32 CMQ" = 16,
    "C33 SCQ" = 17,
    "C34 MTR" = 18,
    "C35 TRQ" = 19,
    "C36T37 OTM" = 20,
    "C40T41 EGW" = 21,
    "C45 CON" = 22,
    "C50T52 WRT" = 23,
    "C55 HTR" = 24,
    "C60T63 TRN" = 25,
    "C64 PTL" = 26,
    "C65T67 FIN" = 27,
    "C70 REA" = 28,
    "C71 RMQ" = 29,
    "C72 ITS" = 30,
    "C73 RDS" = 31,
    "C74 BZS" = 32,
    "C75 GOV" = 33,
    "C80 EDU" = 34,
    "C85 HTH" = 35,
    "C90T93 OTS" = 36,
    "C95 PVH" = 37,
    "......" = 200,
    "C29T30 OTH" = 40
    )

ui.cou <- list(
    "WOR: Total World" = 65,
    "Total OECD" = 64,
    "ASEAN" = 63,
    "East Asia" = 62,
    "NAFTA" = 61,
    "EU27" = 60,
    "EU15" = 59,
    "..." = 100,
    "AUS: Australia" = 1,
    "AUT: Austria" = 2,
    "BEL: Belgium" = 3,
    "CAN: Canada" = 4,
    "CHL: Chile" = 5,
    "CZE: Czech Republic" = 6,
    "DNK: Denmark" = 7,
    "EST: Estonia" = 8,
    "FIN: Finland" = 9,
    "FRA: France" = 10,
    "DEU: Germany" = 11,
    "GRC: Greece" = 12,
    "HUN: Hungary" = 13,
    "ISL: Iceland" = 14,
    "IRL: Ireland" = 15,
    "ISR: Israel" = 16,
    "ITA: Italy" = 17,
    "JPN: Japan" = 18,
    "KOR: Korea" = 19,
    "LUX: Luxembourg" = 20,
    "MEX: Mexico" = 21,
    "NLD: Netherlands" = 22,
    "NZL: New Zealand" = 23,
    "NOR: Norway" = 24,
    "POL: Poland" = 25,
    "PRT: Portugal" = 26,
    "SVK: Slovak Republic" = 27,
    "SVN: Slovenia" = 28,
    "ESP: Spain" = 29,
    "SWE: Sweden" = 30,
    "CHE: Switzerland" = 31,
    "TUR: Turkey" = 32,
    "GBR: United Kingdom" = 33,
    "USA: United States" = 34,
    "ARG: Argentina" = 35,
    "BRA: Brazil" = 36,
    "CHN: China" = 37,
    "TWN: Chinese Taipei" = 38,
    "IND: India" = 39,
    "IDN: Indonesia" = 40,
    "RUS: Russian Federation" = 41,
    "SGP: Singapore" = 42,
    "ZAF: South Africa" = 43,
    "HKG: Hong Kong, China" = 44,
    "MYS: Malaysia" = 45,
    "PHL: Philippines" = 46,
    "THA: Thailand" = 47,
    "ROU: Romania" = 48,
    "VNM: Viet Nam" = 49,
    "SAU: Saudi Arabia" = 50,
    "BRN: Brunei" = 51,
    "BGR: Bulgaria" = 52,
    "CYP: Cyprus" = 53,
    "LVA: Latvia" = 54,
    "LTU: Lithuania" = 55,
    "MLT: Malta" = 56,
    "KHM: Cambodia" = 57,
    "ROW: Rest of the World" = 58
    ## "CHN2" = 59,
    ## "CHN3" = 60,
    ## "CHN4" = 61
    )

## if (exists("reload")==FALSE) reload <- TRUE
## if (reload==TRUE)
## {

## require(shiny)
## require(reshape2)
## require(icioData)
## require(stan)
## require(rMaps)
## require(rCharts)
## require(RColorBrewer)

EXCEL.COL <- rbind.data.frame(
    c("OECDSUT102013", "#4F81BD"),
    c("STANandBTD", "#C0504D"),
    c("WIOT042012", "#9BBB59"),
    c("INDSTAT32", "#8064A2"),
    c("UNSDSNA2013", "#F79646"),
    c("", "#95B3D7"),
    c("", "#DA9694"),
    c("", "#C4D79B"),
    c("", "#FABF8F"),
    c("", "#B1A0C7"),
    c("", "#92CDDC"),
    c("OECDSUT082013", "#4F81BD"),
    c("ICIO052013", "black"))
names(EXCEL.COL) <- c("sou", "col")
EXCEL.COL[,2] <- as.character(EXCEL.COL[,2])

nameyear <- c(1995, 2000, 2005, 2008, 2009)

coef.label <- rbind.data.frame(
    c("eB", "employment"),
    c("vB", "Value added")
    )
names(coef.label) <- c("coef", "label")

demand.label <- rbind.data.frame(
    c("FD", "Final demand"),
    c("GFCF", "Capital formation"),
    c("GRTR", "Gross trade"),
    c("HHCP", "Household consumption")
    )
names(demand.label) <- c("demand", "label")

agg.ind.icio <- rbind.data.frame(
    c("C01T05 AGR", "C01T05 AGR"),
    c("C10T14 MIN", "C10T14 MIN"),
    c("C15T16 FOD", "C15T16 FOD"),
    c("C17T19 TEX", "C17T19 TEX"),
    c("C20T22 WPP", "C20 WOD"),
    c("C20T22 WPP", "C21T22 PAP"),
    c("C23T26 CNM", "C23 PET"),
    c("C23T26 CNM", "C24 CHM"),
    c("C23T26 CNM", "C25 RBP"),
    c("C23T26 CNM", "C26 NMM"),
    c("C27T28 MFM", "C27 MET"),
    c("C27T28 MFM", "C28 FBM"),
    c("C29 MEQ", "C29 MEQ"),
    c("C30T33 ICT", "C30 ITQ"),
    c("C30T33 ICT", "C31 ELQ"),
    c("C30T33 ICT", "C32 CMQ"),
    c("C30T33 ICT", "C33 SCQ"),
    c("C34T35 MTQ", "C34 MTR"),
    c("C34T35 MTQ", "C35 TRQ"),
    c("C36T37 OTM", "C36T37 OTM"),
    c("C40T41 EGW", "C40T41 EGW"),
    c("C45 CON", "C45 CON"),
    c("C50T55 THR", "C50T52 WRT"),
    c("C50T55 THR", "C55 HTR"),
    c("C50T55 THR", "C60T63 TRN"),
    c("C60T64 TRT", "C64 PTL"),
    c("C65T67 FIN", "C65T67 FIN"),
    c("C70T74 BZS", "C70 REA"),
    c("C70T74 BZS", "C71 RMQ"),
    c("C70T74 BZS", "C72 ITS"),
    c("C70T74 BZS", "C73 RDS"),
    c("C70T74 BZS", "C74 BZS"),
    c("C75T95 OTS", "C75 GOV"),
    c("C75T95 OTS", "C80 EDU"),
    c("C75T95 OTS", "C85 HTH"),
    c("C75T95 OTS", "C90T93 OTS"),
    c("C75T95 OTS", "C95 PVH")
    )
names(agg.ind.icio) <- c("ind.icio18", "ind.icio37")

namesec <- as.character(agg.ind.icio[,"ind.icio37"])

secagg <- rbind.data.frame(
    c(38, "C01T99 TOT", 1, 37),
    c(39, "C15T37 MANUF", 3, 20),
    c(40, "C29T30 OTH", 13, 14),
    c(41, "C30T33 ICT", 14, 17),
    c(42, "C50T99 SERV", 23, 37),
    c(43, "C50T74 MKSERV", 23, 32),
    c(44, "C10T74 NAGMK", 2, 32)
    )
names(secagg) <- c("id", "agg", "start", "end")
secagg$id <- as.numeric(as.character(secagg$id))
secagg$start <- as.numeric(as.character(secagg$start))
secagg$end <- as.numeric(as.character(secagg$end))
namesec.agg <- union(namesec, secagg$agg)

namesec.label <- rbind.data.frame(
    c("C01T99 TOT","C01T99","Total","total",0,0,1),
    c("C01T05 AGR","C01T05","Agriculture","agriculture",1,1,0),
    c("C10T74 NAGMK","C10T74","Non-agriculture _ business sector","non-agriculture business sector",0,0,1),
    c("C10T14 MIN","C10T14","Mining","mining",1,1,0),
    c("C15T37 MANUF","C15T37","Manufacturing","manufacturing",0,0,1),
    c("C15T16 FOD","C15T16","Food _ products","food products ",1,1,0),
    c("C17T19 TEX","C17T19","Textile &_ apparel","textile and apparel",1,1,0),
    c("C20T22 WPP","C20T22","Wood &_ paper","wood and paper",0,1,0),
    c("C20 WOD","C20","Wood","wood",1,0,0),
    c("C21T22 PAP","C21T22","Pulp &_ paper","pulp and paper",1,0,0),
    c("C23T26 CNM","C23T26","Chemicals &_ minerals","chemicals and minerals",0,1,0),
    c("C23 PET","C23","Coke &_ petroleum","coke and petroleum",1,0,0),
    c("C24 CHM","C24","Chemical _ products","chemical products",1,0,0),
    c("C25 RBP","C25","Rubber &_ plastics","rubber and plastics",1,0,0),
    c("C26 NMM","C26","Non-metallic _ mineral","non-metallic mineral",1,0,0),
    c("C27T28 MFM","C27T28","Basic &_ fabricated metals","basic and febricated metal",0,1,0),
    c("C27 MET","C27","Basic _ metal","basic metal",1,0,0),
    c("C28 FBM","C28","Fabricated _ metal","fabricated metal",1,0,0),
    c("C29T30 OTH","C29T30","Other &_ office machinery","Other and office machinery",0,0,1),
    c("C29 MEQ","C29","Other _ machinery","other machinery",1,1,0),
    c("C30T33 ICT","C30T33","Electrical _ equipment","electrical equipment",0,0,1),
    c("C30 ITQ","C30","Office _ machinery","office machinery",1,0,0),
    c("C31 ELQ","C31","Electrical _ machinery","electrical machinery",1,0,0),
    c("C32 CMQ","C32","Communication _ equipment","communication equipment",1,0,0),
    c("C33 SCQ","C33","Medical &_ precision","medical and precision equipment",1,0,0),
    c("C34T35 MTQ","C34T35","Transport _ equipment","transport equipment",0,1,0),
    c("C34 MTR","C34","Motor vehicle &_ trailers","motor vehicle and trailer",1,0,0),
    c("C35 TRQ","C35","Other transport _ equipment","other transport equipment",1,0,0),
    c("C36T37 OTM","C36T37","Other _ manufactures","other manufactures",1,1,0),
    c("C40T41 EGW","C40T41","Utilities","utilities",1,1,0),
    c("C45 CON","C45","Construction","construction",1,1,0),
    c("C50T99 SERV","C50T99","Total _ services","total services",0,0,1),
    c("C50T74 MKSERV","C50T74","Business sector _ services","business sector services",0,0,1),
    c("C50T55 THR","C50T55","Trade &_ restaurants","trade and restaurants",0,1,0),
    c("C50T52 WRT","C50T52","Wholesale &_ retail","wholesale and retail",1,0,0),
    c("C55 HTR","C55","Hotels &_ restaurants","hotels and restaurants",1,0,0),
    c("C60T64 TRT","C60T64","Transport &_ telecoms","transport and telecommunications",0,1,0),
    c("C60T63 TRN","C60T63","Transport &_ storage","transport and storage",1,0,0),
    c("C64 PTL","C64","Post &_ telecom","post and telecom",1,0,0),
    c("C65T67 FIN","C65T67","Finance &_ insurance","finance and insurance",1,1,0),
    c("C70T74 BZS","C70T74","Business _ services","business services",0,1,0),
    c("C70 REA","C70","Real _estate","real estate",1,0,0),
    c("C71 RMQ","C71","Renting","renting",1,0,0),
    c("C72 ITS","C72","Computer _ services","computer services",1,0,0),
    c("C73 RDS","C73","Research &_ development","research and development",1,0,0),
    c("C74 BZS","C74","Other _ business","other business",1,0,0),
    c("C75T95 OTS","C75T95","Other services","other services",0,1,0),
    c("C75 GOV","C75","Public _ administration","public administration",1,0,0),
    c("C80 EDU","C80","Education","education",1,0,0),
    c("C85 HTH","C85","Health & social","health and social",1,0,0),
    c("C90T93 OTS","C90T93","Community &_ personal","community and personal",1,0,0),
    c("C95 PVH","C95","Private _ households","private households",1,0,0)
    )
names(namesec.label) <- c("ind", "code", "industry", "indlabel", "ind.icio37", "ind.icio18", "ind.icioagg")

## order and number of items matters - compare with ui
namereg.label <- rbind.data.frame(
    c("AUS","Australia","Australia","Australian",1,0,0,0,0,0,1),
    c("AUT","Austria","Austria","Austrian",1,1,1,0,0,0,1),
    c("BEL","Belgium","Belgium","Belgian",1,1,1,0,0,0,1),
    c("CAN","Canada","Canada","Canadian",1,0,0,1,0,0,1),
    c("CHL","Chile","Chile","Chilean",1,0,0,0,0,0,1),
    c("CZE","Czech Republic","the Czech Republic","Czech",1,0,1,0,0,0,1),
    c("DNK","Denmark","Denmark","Danish",1,1,1,0,0,0,1),
    c("EST","Estonia","Estonia","Estonian",1,0,1,0,0,0,1),
    c("FIN","Finland","Finland","Finnish",1,1,1,0,0,0,1),
    c("FRA","France","France","French",1,1,1,0,0,0,1),
    c("DEU","Germany","Germany","German",1,1,1,0,0,0,1),
    c("GRC","Greece","Greece","Greek",1,1,1,0,0,0,1),
    c("HUN","Hungary","Hungary","Hungarian",1,0,1,0,0,0,1),
    c("ISL","Iceland","Iceland","Icelandish",1,0,0,0,0,0,1),
    c("IRL","Ireland","Ireland","Irish",1,1,1,0,0,0,1),
    c("ISR","Israel","Israel","Israeli",1,0,0,0,0,0,1),
    c("ITA","Italy","Italy","Italian",1,1,1,0,0,0,1),
    c("JPN","Japan","Japan","Japanese",1,0,0,0,1,0,1),
    c("KOR","Korea","Korea","Korean",1,0,0,0,1,0,1),
    c("LUX","Luxembourg","Luxembourg","Luxembourgish",1,1,1,0,0,0,1),
    c("MEX","Mexico","Mexico","Mexican",1,0,0,1,0,0,1),
    c("NLD","Netherlands","the Netherlands","Dutch",1,1,1,0,0,0,1),
    c("NZL","New Zealand","New Zealand","New Zealand's",1,0,0,0,0,0,1),
    c("NOR","Norway","Norway","Norwegian",1,0,0,0,0,0,1),
    c("POL","Poland","Poland","Polish",1,0,1,0,0,0,1),
    c("PRT","Portugal","Portugal","Portuguese",1,1,1,0,0,0,1),
    c("SVK","Slovak Republic","the Slovak Republic","Slovak",1,0,1,0,0,0,1),
    c("SVN","Slovenia","Slovenia","Slovenian",1,0,1,0,0,0,1),
    c("ESP","Spain","Spain","Spainish",1,1,1,0,0,0,1),
    c("SWE","Sweden","Sweden","Swedish",1,1,1,0,0,0,1),
    c("CHE","Switzerland","Switzerland","Swiss",1,0,0,0,0,0,1),
    c("TUR","Turkey","Turkey","Turkish",1,0,0,0,0,0,1),
    c("GBR","United Kingdom","the United Kingdom","UK",1,1,1,0,0,0,1),
    c("USA","United States","the United States","US",1,0,0,1,0,0,1),
    c("ARG","Argentina","Argentina","Argentinian",1,0,0,0,0,0,0),
    c("BRA","Brazil","Brazil","Brazilian",1,0,0,0,0,0,0),
    c("CHN","China","China","Chinese",1,0,0,0,1,0,0),
    c("TWN","Chinese Taipei","Chinese Taipei","Chinese Taipei",1,0,0,0,1,0,0),
    c("IND","India","India","Indian",1,0,0,0,0,0,0),
    c("IDN","Indonesia","Indonesia","Indonesian",1,0,0,0,0,1,0),
    c("RUS","Russian Fed.","the Russian Federation","Russian",1,0,0,0,0,0,0),
    c("SGP","Singapore","Singapore","Singaporean",1,0,0,0,0,1,0),
    c("ZAF","South Africa","South Africa","South African",1,0,0,0,0,0,0),
    c("HKG","Hong Kong","Hong Kong (SAR China)","Hong Kong",1,0,0,0,1,0,0),
    c("MYS","Malaysia","Malaysia","Malaysian",1,0,0,0,0,1,0),
    c("PHL","Philippines","Philippines","Filipino",1,0,0,0,0,1,0),
    c("THA","Thailand","Thailand","Thai",1,0,0,0,0,1,0),
    c("ROU","Romania","Romania","Romanian",1,0,1,0,0,0,0),
    c("VNM","Viet Nam","Viet Nam","Vietnamese",1,0,0,0,0,1,0),
    c("SAU","Saudi Arabia","Saudi Arabia","Saudi Arabian",1,0,0,0,0,0,0),
    c("BRN","Brunei Darussalam","Brunei Darussalam","Bruneian",1,0,0,0,0,1,0),
    c("BGR","Bulgaria","Bulgaria","Bulgarian",1,0,1,0,0,0,0),
    c("CYP","Cyprus","Cyprus","Cypriot",1,0,1,0,0,0,0),
    c("LVA","Latvia","Latvia","Latvian",1,0,1,0,0,0,0),
    c("LTU","Lithuania","Lithuania","Lithuanian",1,0,1,0,0,0,0),
    c("MLT","Malta","Malta","Maltese",1,0,1,0,0,0,0),
    c("KHM","Cambodia","Cambodia","Cambodian",1,0,0,0,0,1,0),
    c("ROW","Rest_of the_World","the Rest of the World","Rest of the World's",1,0,0,0,0,0,0),
    c("EU15","EU 15","EU 15","EU 15",0,0,0,0,0,0,0),
    c("EU27","EU 27","EU 27","EU 27",0,0,0,0,0,0,0),
    c("NAFTA","NAFTA","NAFTA","NAFTA",0,0,0,0,0,0,0),
    c("E_ASIA","East Asia","East Asia","East Asia",0,0,0,0,0,0,0),
    c("ASEAN","ASEAN","ASEAN","ASEAN",0,0,0,0,0,0,0),
    c("OECD","Total OECD","Total OECD","Total OECD",0,0,0,0,0,0,0),
    c("WOR","Total World","Total World","Total World",0,0,0,0,0,0,0)
    )
names(namereg.label) <- c("cou","country", "coulabel", "coupron", "reg.WOR", "reg.EU15", "reg.EU27", "reg.NAFTA", "reg.E_ASIA", "reg.ASEAN", "reg.OECD")

region <- sub("reg.", "", names(namereg.label)[substr(names(namereg.label), 1, 4)=="reg."])

## create character vectors "EU15", "EU27" etc. with member country codes
namereg <- namereg.label$cou[namereg.label$reg.WOR==1]
for (reg in region) # c("WOR", "EU27", "NAFTA", "E_ASIA", "ASEAN", "OECD")
{
    eval(parse(text = paste0(reg, ' <- namereg.label$cou[namereg.label$reg.', reg, '==1]')))
}

namereg.list <- NULL
for (j in seq(along=namereg))
{
    namereg.list <- c(namereg.list, list(j))
    names(namereg.list)[j] <- as.character(namereg[j])
}
##

namereg.agg <- list(EU15 = match(EU15, namereg),
                    EU27 = match(EU27, namereg),
                    NAFTA = match(NAFTA, namereg),
                    E_ASIA = match(E_ASIA, namereg),
                    ASEAN = match(ASEAN, namereg),
                    OECD = match(OECD, namereg),
                    WOR = match(WOR, namereg))

namereg.agg <- c(namereg.list, namereg.agg)
##
rownames <- merge(namesec, namereg)
rownames<- paste(rownames[,2], rownames[,1])
colnames <- namereg
dimnames=list(rownames, colnames)

##
## data loading
## ICIO5837EB
## data(ICIO5837APP)



##
nocou <- isolate(dim(values[["ICIO5837APP"]]$DATA.ICIO5837GRTR)[2])
noind <- isolate(dim(values[["ICIO5837APP"]]$DATA.ICIO5837GRTR)[1]) / nocou
## nocou <- dim(DATA.ICIO5837GRTR)[2]
## noind <- dim(DATA.ICIO5837GRTR)[1] / nocou
##
dim_conv <- list(row=c(nocou, noind), col=c(nocou))
## }


## input <- list(nav_radiant="Icio",
##               coef="eB",
##               indS=38,
##               couS=64,
##               couX=65,
##               indX=41,
##               couD=60,
##               nocouX=FALSE,
##               noindX=FALSE,
##               time=4,
##               demand="GRTR",
##               calcshare=FALSE,
##               rounddec=4,
##               sortdata="desc",
##               aggindX=FALSE,
##               topN=5,
##               datatabs=3)
## input


output$ui_icio <- renderUI({
    list(
  	wellPanel(

            selectInput("coef", "Coefficients:",
                        list(
                            "eB: Employment" = "eB",
                            "vB: Value-added" = "vB"
                            )
                        ),
            selectInput("time", "Year:",
                        list(
                            "2009" = 5,
                            "2008" = 4,
                            "2005" = 3,
                            "2000" = 2,
                            "1995" = 1
                            )
                        ),
            ## conditionalPanel(condition="input.datatabs==3 | input.datatabs==4 | input.datatabs==5 | input.datatabs==6" ,
            selectInput("demand", "Demand concept: (demand)",
                        list(
                            "GRTR: Gross Trade" = "GRTR",
                            "FD: Final Demand" = "FD",
                            "GFCF: Gross Fixed Capital Formation" = "GFCF",
                            "HHCP: Household Consumption" = "HHCP"
                            ),
                        selected = "FD"
                        )
            ## )
            ,
            ## conditionalPanel(condition="input.datatabs==3 | input.datatabs==4 | input.datatabs==5 | input.datatabs==6" ,
            selectInput("indX", "Demand or Final Expenditure Industry: (indX)", ui.ind,
                        selected = 39) # 39: C15T37 MANUF; 41: "C30T33 ICT"
                             ## )
            ,
            ## conditionalPanel(condition="input.datatabs==3 | input.datatabs==4 | input.datatabs==5 | input.datatabs==6" ,
            selectInput("couX", "Export Country: (couX)", ui.cou,
                        selected = 62) # 62: East Asia; 65: WOR: Total World"
            ## )
            ,
            ## conditionalPanel(condition="input.datatabs==3 | input.datatabs==4 | input.datatabs==5 | input.datatabs==6" ,
            selectInput("couD", "Demand Country: (couD)", ui.cou,
                        selected = 60) # EU27
            ## )
            ,

            ## radioButtons(inputId = "dimS", label = "Source Dimension:",
            ##              c("Industry" = "ind", "Country" = "cou"), selected = "ind"),
            ## conditionalPanel(condition="input.dimS==ind",
            ## conditionalPanel(condition="input.datatabs==3 | input.datatabs==4",
            selectInput("couS", "Source Country: (couS)", ui.cou,
                        selected = 64) # "Total OECD"
            ## )
            ,
            ## conditionalPanel(condition="input.dimS==cou",
            ## conditionalPanel(condition="input.datatabs==5 | input.datatabs==6",
            selectInput("indS", "Source Industry: (indS)", ui.ind,
                        selected = 38) # "C01T99 TOT"
            ## )
            ,

            checkboxInput("calcshare", "Calculate share in total", FALSE),
            ## conditionalPanel(condition="input.datatabs==3 | input.datatabs==4" ,
            checkboxInput("noindX", "Remove 'Export Industry' from chart", FALSE)
                             ## )
            ,
            ## conditionalPanel(condition="input.datatabs==4" ,
            ##                  checkboxInput("aggindX", "Add ICIO 18 industry aggregates", FALSE)
            ##                  ),
            ## conditionalPanel(condition="input.datatabs==5 | input.datatabs==6" ,
            ##                  checkboxInput("nocouX", "Remove 'Export Country' from chart", FALSE)
            ##                  ),
            numericInput("rounddec", "Round to number of decimals:", 4),
            ## conditionalPanel(condition="input.datatabs==3 | input.datatabs==5" ,
            numericInput("topN", "Display first N values in legend:", 5)
            ## )
            ,
            selectInput("sortdata", "Order or sorting (legend, table):",
                        list(
                            'ICIO industry order' = "",
                            'Decending value' = "desc",
                            'Ascending value' = "asc"
                            )),
            downloadButton('downloadData', 'Download CSV'),
            h6("Explanation Flow Diagram", a("Source-Export-Demand",
                                             href="https://www.dropbox.com/s/duzwe197fr844h9/flow_diagram.png",
                                             ## href="https://www.dropbox.com/s/mj7kv7254d2pwjt/flow_diagram.pdf",
                                             target="_blank"))

            ),
        helpAndReport('Icio','icio',inclMD("tools/help/icio.md"))
 	)
})

output$icio <- renderUI({
    ## for input-output
    statTabPanel(menu_name = "ICIO Indicator", # menu_name: for side bar - coincide with navbarMenu
                 fun_name = "FDDVA",           # fun_name
                 rfun_label = ".icio",         # rfun_label
                 fun_label = "icio")           # fun_label
})

.icio <- reactive({
    ## reactive that calls the function for main analysis
    ## . used to indicate this is an 'internal' function

    ## if (input$dimS=="ind")
    ## {
        icio(coef = input$coef,
             year = nameyear[as.numeric(input$time)],
             demand = input$demand,
             indX = namesec.agg[as.numeric(input$indX)],
             ## indS = namesec.agg[as.numeric(input$indS)],
             couS = names(namereg.agg)[as.numeric(input$couS)],
             couX = names(namereg.agg)[as.numeric(input$couX)],
             couD = names(namereg.agg)[as.numeric(input$couD)]
             )
    ## }
})

## isolate(.icio())

observe({
    if(is.null(input$icioReport) || input$icioReport == 0) return()
    isolate({
        inp <- list(
            input$datasets,

            input$coef,
            nameyear[as.numeric(input$time)],
            input$demand,
            namesec.agg[as.numeric(input$indX)],
            ## indS = namesec.agg[as.numeric(input$indS)],
            names(namereg.agg)[as.numeric(input$couS)],
            names(namereg.agg)[as.numeric(input$couX)],
            names(namereg.agg)[as.numeric(input$couD)]
            )

        updateReport(inp,"icio")
    })
})

icio <- function(coef = coef,
                 year = year,
                 demand = demand,
                 indX = indX,
                 ## indS = indS,
                 couS = couS,
                 couX = couX,
                 couD = couD)
{
    title <- list(coef = coef,
                  year = year,
                  demand = demand,
                  indX = indX,
                  ## indS = indS,
                  couS = couS,
                  couX = couX,
                  couD = couD
                  )

    title.string <- NULL
    for (i in seq(along=title))
    {
        if (is.null(title.string))
        {
            title.string <- paste(toString(names(title[i])), toString(title[[i]]), sep = ": ")
        }
        else
        {
            title.string <- paste(title.string, paste(toString(names(title[i])), toString(title[[i]]), sep = ": "), sep = ", ")
        }
    }

    ## result <- title.string
    ## result

    ## return(title.string = title.string)
    return(list(title.string = title.string, dat = c(1,2,3)))
}

summary_icio <- function(result = .icio()) {

    ## result
    ## if(!is.null(result$title.string)) {
    ## if(!is.null(result)) {
    ##     cat("Title:\n")
    ##     print(result)
    print(result$title.string)
    ## }
}
## summary_icio(result = isolate(.icio()))

plots_icio <- function(result = .icio())
{
    ## if(!is.null(result$title.string)) {
    ## if(!is.null(result)) {
    ##     ## title.string <- result$title.string
    ##     title.string <- result
    ## return(plot(c(1,2,3), main = title.string))
    ## }
    ## return(plot(c(1,2,3), main = result))
    p <- ggplot(data.frame(location = c(1,2,3),
                           values = c(1,2,3))) + geom_point(aes(x = location, y = values)) +
                               ggtitle(result)
    print(p)
}
## plots_icio(result = isolate(.icio()))

## saveTreatmentAssign <- function(result = .icio()) {
## ## radiant.R
##     changedata(data.frame(as.factor(result$dat$treatment)),
##                "treatment") # addColName: return(values[[input$datasets]][,addColName] <- addCol)
## }

## observe({
##   ## rnd_save_treatment: actionButton
##     if(is.null(input$rnd_save_treatment) || input$rnd_save_treatment == 0) return()
##     isolate({
##         result <- .icio()
##         if(is.character(result)) return()
##         saveTreatmentAssign(result)
##     })
## })
